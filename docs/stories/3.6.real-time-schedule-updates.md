# Story 3.6: Real-time Schedule Updates

## Status
üìù **Draft** - Ready for development with comprehensive architecture context

## Story
**As a** guard or manager,
**I want** to receive immediate notifications of schedule changes,
**so that** I can respond quickly to shift assignments, cancellations, and urgent coverage needs.

## Acceptance Criteria
1. Implement real-time notification system using Supabase subscriptions for schedule changes
2. Create in-app notification interface with unread counts and action buttons for quick responses
3. Configure email notifications for critical schedule changes with mobile-optimized templates
4. Implement notification preferences allowing users to control frequency and delivery methods
5. Create notification history and acknowledgment tracking for accountability purposes
6. Configure emergency notification escalation for urgent shift coverage requirements

## Tasks / Subtasks

### Task 1: Real-time Notification Infrastructure (AC: 1)
- [ ] Create NotificationService using Supabase real-time subscriptions
- [ ] Implement real-time triggers for shift creation, assignment, and status changes
- [ ] Build notification payload standardization with event types and metadata
- [ ] Add notification delivery queue with retry mechanisms
- [ ] Create notification filtering by user role and subscription preferences
- [ ] Implement notification deduplication to prevent spam
- [ ] Add notification broadcast service for multi-user alerts

### Task 2: In-app Notification Interface (AC: 2)
- [ ] Create NotificationCenter component with real-time updates
- [ ] Implement notification badge with unread count indicators
- [ ] Build notification dropdown with categorized view (urgent, normal, info)
- [ ] Add quick action buttons (Accept, Decline, View Details, Mark Read)
- [ ] Create notification toast system for immediate alerts
- [ ] Implement notification sound preferences and visual indicators
- [ ] Add notification search and filtering within the interface

### Task 3: Email Notification System (AC: 3)
- [ ] Create EmailNotificationService with template management
- [ ] Implement mobile-optimized HTML email templates
- [ ] Build email notification triggers for critical schedule changes
- [ ] Add email preference management (immediate, digest, disabled)
- [ ] Create email delivery status tracking and bounce handling
- [ ] Implement email template personalization with user context
- [ ] Add email unsubscribe mechanism with granular control

### Task 4: Notification Preferences Management (AC: 4)
- [ ] Create NotificationPreferences component for user settings
- [ ] Implement notification type selection (shifts, availability, emergencies)
- [ ] Build delivery method configuration (in-app, email, both)
- [ ] Add notification timing preferences (immediate, scheduled, digest)
- [ ] Create role-based notification defaults with customization options
- [ ] Implement notification quiet hours and do-not-disturb settings
- [ ] Add bulk notification preference management for administrators

### Task 5: Notification History and Tracking (AC: 5)
- [ ] Create NotificationHistory component with search and filtering
- [ ] Implement notification read/unread status tracking
- [ ] Build notification acknowledgment system with timestamps
- [ ] Add notification delivery confirmation and failure tracking
- [ ] Create notification analytics dashboard for administrators
- [ ] Implement notification retention policy with archival system
- [ ] Add notification export functionality for audit purposes

### Task 6: Emergency Escalation System (AC: 6)
- [ ] Create EmergencyNotificationService for urgent situations
- [ ] Implement escalation rules based on shift criticality and timing
- [ ] Build escalation chain management (guard ‚Üí manager ‚Üí admin)
- [ ] Add emergency notification channels (SMS, phone calls) integration
- [ ] Create emergency acknowledgment requirements with timeouts
- [ ] Implement emergency notification override for critical situations
- [ ] Add emergency escalation audit trail for compliance

### Task 7: Notification Components and UI
- [ ] Create NotificationBell component with real-time badge updates
- [ ] Build NotificationDropdown with categorized notification display
- [ ] Implement NotificationToast component with action buttons
- [ ] Add NotificationHistory component with pagination and search
- [ ] Create NotificationPreferences component with intuitive settings
- [ ] Build EmergencyAlert component for critical notifications
- [ ] Add NotificationSound component with audio preference controls

### Task 8: API Endpoints Development
- [ ] Create /api/v1/notifications endpoint for notification management
- [ ] Create /api/v1/notifications/preferences endpoint for user settings
- [ ] Create /api/v1/notifications/history endpoint for notification logs
- [ ] Create /api/v1/notifications/acknowledge endpoint for read status
- [ ] Create /api/v1/notifications/emergency endpoint for urgent notifications
- [ ] Create /api/v1/notifications/test endpoint for testing notification delivery
- [ ] Add notification API endpoints authentication and role validation

### Task 9: Database Schema Extensions
- [ ] Create notifications table for notification storage and tracking
- [ ] Create notification_preferences table for user notification settings
- [ ] Create notification_history table for delivery tracking and acknowledgments
- [ ] Create emergency_notifications table for escalation management
- [ ] Add notification triggers to shifts, availability, and assignment tables
- [ ] Implement proper RLS policies for notification data security
- [ ] Add indexes for notification queries and real-time performance

### Task 10: Integration with Email Service
- [ ] Integrate with email service provider (SendGrid/AWS SES)
- [ ] Create email template management system
- [ ] Implement email delivery tracking and analytics
- [ ] Add email bounce and complaint handling
- [ ] Create email template preview and testing functionality
- [ ] Implement email personalization with dynamic content
- [ ] Add email delivery optimization and rate limiting

### Task 11: Testing Implementation (All ACs)
- [ ] Test real-time notification delivery with Supabase subscriptions
- [ ] Test in-app notification interface with real-time updates
- [ ] Test email notification delivery with various templates
- [ ] Test notification preferences and user control features
- [ ] Test notification history and acknowledgment tracking
- [ ] Test emergency escalation workflows and timeout handling
- [ ] Test notification performance under high load scenarios

## Dev Notes

### Previous Story Insights
**From Story 3.1: Shift Creation & Management**
- `shifts` table established with status tracking ready for notification triggers
- Shift priority levels ready for emergency notification classification
- Manager assignment system ready for notification routing and escalation

**From Story 3.2: Shift Assignment & Eligibility System**
- Guard assignment system ready for assignment notification triggers
- Assignment conflict detection ready for urgent notification scenarios
- Batch assignment capabilities ready for bulk notification handling

**From Story 3.3: Guard Availability Management**
- Availability management system ready for availability change notifications
- Time-off request system ready for approval workflow notifications
- Emergency unavailability ready for urgent notification triggers

**From Story 3.4: Shift Kanban Board**
- Real-time shift updates ready for notification integration
- Urgent shift alerts system provides foundation for emergency escalation
- Manager collaboration system ready for notification coordination

**From Story 3.5: Calendar Integration System**
- Calendar sync preferences ready for notification delivery integration
- Real-time calendar sync ready for schedule change notification triggers
- Role-based access control patterns ready for notification filtering

### Epic 2 Integration Requirements
**Manager Authentication & Permissions** [Source: architecture/data-models-and-schema-changes.md#user-roles-permissions-rbac]
- **RBAC Integration**: Managers receive team notifications, guards receive personal notifications
- **Notification Routing**: Admin users receive system-wide notifications with escalation privileges
- **Audit Trail Integration**: All notification events logged with user roles and acknowledgment status

### Data Models Extensions
**Real-time Notification Schema:**
```sql
-- Core notification storage and tracking
CREATE TABLE public.notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- Notification Recipients and Routing
    recipient_id UUID REFERENCES auth.users(id) NOT NULL,
    sender_id UUID REFERENCES auth.users(id), -- NULL for system notifications
    
    -- Notification Content and Classification
    notification_type public.notification_type_enum NOT NULL,
    priority public.notification_priority_enum DEFAULT 'normal',
    category public.notification_category_enum NOT NULL,
    
    -- Message Content
    title TEXT NOT NULL,
    message TEXT NOT NULL,
    action_data JSONB DEFAULT '{}'::jsonb, -- Action buttons and metadata
    
    -- Context and References
    entity_type TEXT, -- 'shift', 'availability', 'application'
    entity_id UUID, -- Reference to related entity
    
    -- Delivery and Status Tracking
    delivery_status public.delivery_status_enum DEFAULT 'pending',
    delivery_channels TEXT[] DEFAULT ARRAY['in_app'], -- in_app, email, sms
    
    -- Read Status and Acknowledgment
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMPTZ,
    acknowledged_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ, -- For temporary notifications
    
    -- Audit Trail
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Performance Indexes
    INDEX idx_notifications_recipient_id (recipient_id),
    INDEX idx_notifications_created_at (created_at DESC),
    INDEX idx_notifications_unread (recipient_id, is_read) WHERE is_read = FALSE,
    INDEX idx_notifications_priority (priority) WHERE priority IN ('urgent', 'emergency'),
    INDEX idx_notifications_entity (entity_type, entity_id) WHERE entity_type IS NOT NULL
);

CREATE TYPE public.notification_type_enum AS ENUM (
    'shift_assignment',     -- Shift assigned to guard
    'shift_cancellation',   -- Shift cancelled
    'shift_modification',   -- Shift details changed
    'availability_request', -- Availability change request
    'time_off_approved',    -- Time off request approved
    'time_off_denied',      -- Time off request denied
    'emergency_coverage',   -- Urgent shift coverage needed
    'system_alert',         -- System maintenance, updates
    'calendar_sync_failed', -- Calendar integration issues
    'compliance_reminder'   -- Certification expiry, etc.
);

CREATE TYPE public.notification_priority_enum AS ENUM (
    'low',          -- Information only
    'normal',       -- Standard notifications
    'high',         -- Important but not urgent
    'urgent',       -- Requires immediate attention
    'emergency'     -- Critical operational issue
);

CREATE TYPE public.notification_category_enum AS ENUM (
    'schedule',     -- Schedule-related notifications
    'availability', -- Availability and time-off
    'assignments',  -- Shift assignments
    'system',       -- System and administrative
    'compliance',   -- Compliance and certifications
    'emergency'     -- Emergency situations
);

CREATE TYPE public.delivery_status_enum AS ENUM (
    'pending',      -- Queued for delivery
    'delivered',    -- Successfully delivered
    'failed',       -- Delivery failed
    'bounced',      -- Email bounced
    'retrying'      -- Retry in progress
);
```

**Notification Preferences Schema:**
```sql
CREATE TABLE public.notification_preferences (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) NOT NULL,
    
    -- Delivery Method Preferences
    in_app_notifications BOOLEAN DEFAULT TRUE,
    email_notifications BOOLEAN DEFAULT TRUE,
    sms_notifications BOOLEAN DEFAULT FALSE, -- Future enhancement
    
    -- Category-specific Preferences
    schedule_notifications BOOLEAN DEFAULT TRUE,
    availability_notifications BOOLEAN DEFAULT TRUE,
    assignment_notifications BOOLEAN DEFAULT TRUE,
    system_notifications BOOLEAN DEFAULT TRUE,
    compliance_notifications BOOLEAN DEFAULT TRUE,
    emergency_notifications BOOLEAN DEFAULT TRUE, -- Cannot be disabled
    
    -- Timing and Frequency Preferences
    notification_frequency public.frequency_enum DEFAULT 'immediate',
    quiet_hours_start TIME,
    quiet_hours_end TIME,
    weekend_notifications BOOLEAN DEFAULT TRUE,
    
    -- Email Specific Preferences
    email_digest_enabled BOOLEAN DEFAULT FALSE,
    email_digest_frequency public.digest_frequency_enum DEFAULT 'daily',
    
    -- Priority Filtering
    minimum_priority public.notification_priority_enum DEFAULT 'normal',
    
    -- Audit Trail
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX idx_notification_preferences_user_id (user_id),
    
    -- Constraints
    UNIQUE(user_id) -- One preference record per user
);

CREATE TYPE public.frequency_enum AS ENUM (
    'immediate',    -- Real-time notifications
    'batched_5min', -- Every 5 minutes
    'batched_1hr',  -- Every hour
    'daily_digest', -- Once per day
    'disabled'      -- No notifications (except emergency)
);

CREATE TYPE public.digest_frequency_enum AS ENUM (
    'daily',        -- Daily email digest
    'weekly',       -- Weekly summary
    'monthly'       -- Monthly report
);
```

**Notification History and Tracking:**
```sql
CREATE TABLE public.notification_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    notification_id UUID REFERENCES public.notifications(id) NOT NULL,
    
    -- Delivery Attempt Details
    delivery_channel TEXT NOT NULL, -- 'in_app', 'email', 'sms'
    delivery_attempt INTEGER DEFAULT 1,
    delivery_status public.delivery_status_enum NOT NULL,
    
    -- Delivery Metadata
    delivery_provider TEXT, -- 'supabase', 'sendgrid', 'twilio'
    external_id TEXT, -- Provider's message ID
    
    -- Error Details
    error_message TEXT,
    error_code TEXT,
    
    -- Performance Metrics
    delivery_duration_ms INTEGER,
    
    -- Audit Trail
    attempted_at TIMESTAMPTZ DEFAULT NOW(),
    delivered_at TIMESTAMPTZ,
    
    INDEX idx_notification_history_notification_id (notification_id),
    INDEX idx_notification_history_attempted_at (attempted_at DESC),
    INDEX idx_notification_history_status (delivery_status) WHERE delivery_status = 'failed'
);
```

**Emergency Escalation Schema:**
```sql
CREATE TABLE public.emergency_notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- Emergency Details
    emergency_type public.emergency_type_enum NOT NULL,
    entity_type TEXT NOT NULL, -- 'shift', 'site', 'guard'
    entity_id UUID NOT NULL,
    
    -- Escalation Configuration
    escalation_level INTEGER DEFAULT 1,
    max_escalation_level INTEGER DEFAULT 3,
    escalation_timeout_minutes INTEGER DEFAULT 15,
    
    -- Current Status
    current_status public.escalation_status_enum DEFAULT 'active',
    acknowledged_by UUID REFERENCES auth.users(id),
    acknowledged_at TIMESTAMPTZ,
    resolved_at TIMESTAMPTZ,
    
    -- Escalation Chain
    escalation_chain JSONB NOT NULL, -- Array of user IDs and contact methods
    current_assignee UUID REFERENCES auth.users(id),
    
    -- Notification History
    notifications_sent INTEGER DEFAULT 0,
    last_notification_at TIMESTAMPTZ,
    
    -- Audit Trail
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    created_by UUID REFERENCES auth.users(id) NOT NULL,
    
    INDEX idx_emergency_notifications_entity (entity_type, entity_id),
    INDEX idx_emergency_notifications_status (current_status) WHERE current_status = 'active',
    INDEX idx_emergency_notifications_escalation (escalation_level, current_status)
);

CREATE TYPE public.emergency_type_enum AS ENUM (
    'unassigned_critical_shift',  -- Critical shift without guard
    'guard_no_show',              -- Guard failed to show up
    'site_emergency',             -- Emergency at client site
    'compliance_violation',       -- Critical compliance issue
    'system_failure'              -- Platform system failure
);

CREATE TYPE public.escalation_status_enum AS ENUM (
    'active',       -- Currently escalating
    'acknowledged', -- Someone acknowledged
    'resolved',     -- Emergency resolved
    'expired',      -- Escalation timeout reached
    'cancelled'     -- Emergency cancelled
);
```

### Component Specifications
**Real-time Notification Architecture** [Source: architecture/component-architecture.md#dashboard-layout-system]
- **Supabase Real-time**: Real-time subscriptions for instant notification delivery
- **Role-based Filtering**: Notifications filtered by user role and subscription preferences
- **Multi-channel Delivery**: In-app, email, and future SMS notification support
- **Emergency Escalation**: Automatic escalation chains with timeout management

**Core Notification Components:**
```typescript
// Main Notification Components
<NotificationCenter />                          // Primary notification hub
<NotificationBell badgeCount={unreadCount} />   // Navigation notification indicator
<NotificationDropdown notifications={notifications} /> // Notification list dropdown
<NotificationToast notification={notification} /> // Real-time toast notifications

// Preference and Management Components
<NotificationPreferences userId={userId} />      // User notification settings
<NotificationHistory userId={userId} />          // Notification history viewer
<EmergencyAlertBanner emergency={emergency} />   // Critical emergency alerts

// Administrative Components
<NotificationAnalytics />                        // Admin notification metrics
<EmergencyEscalationPanel />                     // Emergency management interface
<NotificationTestingPanel />                     // Testing and debugging tools
```

### API Specifications
**Real-time Notification APIs** [Source: architecture/api-design-and-integration.md#api-integration-strategy]
- Follow established ServiceResult pattern from Stories 3.1-3.5
- Supabase real-time subscriptions for instant delivery
- Role-based access control with audit logging

**Required API Endpoints:**
```typescript
// Notification Management
GET    /api/v1/notifications                    // Get user notifications with filtering
POST   /api/v1/notifications                   // Create new notification (admin)
PUT    /api/v1/notifications/:id/acknowledge   // Mark notification as read/acknowledged
DELETE /api/v1/notifications/:id               // Delete notification (admin)

// Notification Preferences
GET    /api/v1/notifications/preferences       // Get user notification preferences
PUT    /api/v1/notifications/preferences       // Update notification preferences
POST   /api/v1/notifications/preferences/test  // Test notification delivery

// Notification History
GET    /api/v1/notifications/history           // Get notification delivery history
GET    /api/v1/notifications/analytics         // Get notification analytics (admin)

// Emergency Notifications
POST   /api/v1/notifications/emergency         // Create emergency notification
PUT    /api/v1/notifications/emergency/:id/escalate // Manual escalation trigger
PUT    /api/v1/notifications/emergency/:id/resolve  // Resolve emergency

// Real-time Subscriptions
WS     /api/v1/notifications/subscribe         // WebSocket for real-time notifications
POST   /api/v1/notifications/broadcast         // Broadcast to multiple users (admin)
```

### File Locations
**Component Structure** [Source: architecture/source-tree-integration.md#new-file-organization]
```
app/dashboard/notifications/
‚îú‚îÄ‚îÄ page.tsx                          # Main notification center page
‚îú‚îÄ‚îÄ preferences/page.tsx              # Notification preferences
‚îú‚îÄ‚îÄ history/page.tsx                  # Notification history
‚îî‚îÄ‚îÄ emergency/page.tsx                # Emergency notification management (admin)

components/notifications/
‚îú‚îÄ‚îÄ NotificationCenter.tsx            # Main notification hub
‚îú‚îÄ‚îÄ NotificationBell.tsx              # Navigation notification bell
‚îú‚îÄ‚îÄ NotificationDropdown.tsx          # Notification list dropdown
‚îú‚îÄ‚îÄ NotificationToast.tsx             # Real-time toast notifications
‚îú‚îÄ‚îÄ NotificationPreferences.tsx       # User preference management
‚îú‚îÄ‚îÄ NotificationHistory.tsx           # Notification history viewer
‚îú‚îÄ‚îÄ EmergencyAlertBanner.tsx          # Critical emergency alerts
‚îî‚îÄ‚îÄ NotificationAnalytics.tsx         # Admin analytics dashboard

lib/services/
‚îú‚îÄ‚îÄ notification-service.ts          # Core notification management
‚îú‚îÄ‚îÄ notification-delivery-service.ts # Multi-channel delivery logic
‚îú‚îÄ‚îÄ email-notification-service.ts    # Email template and delivery
‚îú‚îÄ‚îÄ emergency-escalation-service.ts  # Emergency notification escalation
‚îú‚îÄ‚îÄ notification-preferences-service.ts # User preference management
‚îî‚îÄ‚îÄ notification-analytics-service.ts # Analytics and reporting

lib/types/
‚îú‚îÄ‚îÄ notification-types.ts            # Notification interfaces and enums
‚îú‚îÄ‚îÄ emergency-types.ts               # Emergency escalation types
‚îî‚îÄ‚îÄ preference-types.ts              # Notification preference types

app/api/v1/notifications/
‚îú‚îÄ‚îÄ route.ts                          # Main notification operations
‚îú‚îÄ‚îÄ preferences/route.ts              # Preference management
‚îú‚îÄ‚îÄ history/route.ts                  # Notification history
‚îú‚îÄ‚îÄ acknowledge/route.ts              # Acknowledgment handling
‚îú‚îÄ‚îÄ emergency/route.ts                # Emergency notifications
‚îî‚îÄ‚îÄ subscribe/route.ts                # Real-time subscription endpoint
```

### Real-time Integration Requirements
**Supabase Real-time Subscriptions** [Source: architecture/tech-stack-alignment.md#existing-technology-stack]
- Real-time triggers on shifts, availability, and assignment table changes
- Filtered subscriptions based on user role and notification preferences
- Optimistic UI updates with real-time notification delivery
- Connection management with automatic reconnection and backoff

### Business Logic Integration
**Notification Triggers:**
- Automatic notifications on shift assignment, cancellation, and modification
- Availability request notifications with manager approval workflows
- Emergency escalation for unassigned shifts within critical timeframes
- Calendar sync failure notifications with troubleshooting guidance

**Security and Privacy Controls:**
- Role-based notification filtering (managers see team events, guards see personal)
- Notification content filtering based on user permissions
- Emergency notification bypass for critical operational situations
- Audit logging for all notification events and acknowledgments

### Technical Constraints
**Technology Stack Alignment** [Source: architecture/tech-stack-alignment.md#new-technology-additions]
- React 19 with TypeScript 5 maintaining strict mode compliance
- Next.js 15.3.5 App Router with real-time API integration
- Supabase real-time subscriptions for instant notification delivery
- Email service integration (SendGrid/AWS SES) for external notifications

**Integration Requirements:**
- Epic 2 RBAC system integration for role-based notification routing
- Stories 3.1-3.5 shift, availability, and calendar system integration
- ServiceResult pattern consistency across all Epic 3 stories
- Real-time performance optimization for high-volume notification scenarios

### Testing
**Testing Framework** [Source: architecture/testing-strategy.md#new-testing-requirements]
- **Framework:** Jest + React Testing Library for notification components
- **Real-time Testing:** Mock Supabase subscriptions for notification testing
- **Database Tests:** pgTAP for notification RLS policies and trigger validation
- **Integration Tests:** Playwright for end-to-end notification workflows
- **Coverage Target:** 95% business logic, 85% UI components

**Critical Test Scenarios:**
- Real-time notification delivery with Supabase subscriptions
- Multi-channel notification delivery (in-app, email)
- Role-based notification filtering for managers and guards
- Emergency escalation workflows with timeout handling
- Notification preference management and respect of user settings
- High-volume notification performance and queue management

**Required Test Files:**
```
components/notifications/__tests__/
‚îú‚îÄ‚îÄ NotificationCenter.test.tsx
‚îú‚îÄ‚îÄ NotificationBell.test.tsx
‚îú‚îÄ‚îÄ NotificationDropdown.test.tsx
‚îú‚îÄ‚îÄ NotificationToast.test.tsx
‚îî‚îÄ‚îÄ NotificationPreferences.test.tsx

lib/services/__tests__/
‚îú‚îÄ‚îÄ notification-service.test.ts
‚îú‚îÄ‚îÄ notification-delivery-service.test.ts
‚îú‚îÄ‚îÄ email-notification-service.test.ts
‚îî‚îÄ‚îÄ emergency-escalation-service.test.ts

app/api/v1/notifications/__tests__/
‚îú‚îÄ‚îÄ notifications.test.ts
‚îú‚îÄ‚îÄ preferences.test.ts
‚îú‚îÄ‚îÄ history.test.ts
‚îî‚îÄ‚îÄ emergency.test.ts

supabase/tests/database/
‚îú‚îÄ‚îÄ notifications_rls.test.sql
‚îú‚îÄ‚îÄ notification_preferences.test.sql
‚îî‚îÄ‚îÄ emergency_notifications.test.sql
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | 1.0 | Initial story creation for Epic 3.6 with comprehensive architecture context | Scrum Master |
# Story 4.3: Certification Expiry Management

## Status
âœ… **Ready for Review** - Implementation complete, awaiting QA validation

## Story
**As a** manager,
**I want** automated tracking and alerts for expiring guard certifications,
**so that** I can ensure continuous compliance and prevent scheduling guards with expired credentials.

## Acceptance Criteria
1. Implement certification expiry monitoring with automated alerts at 30, 14, and 7 days before expiration
2. Create certification renewal workflow with document upload and verification requirements
3. Configure automatic scheduling restriction for guards with expired certifications
4. Implement certification history tracking with renewal dates and issuing authority information
5. Create compliance dashboard showing all guards with upcoming certification expirations
6. Configure escalation notifications to management for guards who fail to renew certifications

## Tasks / Subtasks

### Task 1: Certification Expiry Monitoring (AC: 1)
- [x] Create CertificationMonitoringService for expiry tracking
- [x] Implement automated daily check for upcoming expirations
- [x] Add alert triggers at 30, 14, and 7 days before expiration
- [x] Create notification templates for certification expiry alerts
- [x] Test monitoring service with sample certification data

### Task 2: Renewal Workflow (AC: 2)
- [x] Create certification renewal interface for guards
- [x] Implement document upload for renewal certificates
- [x] Add verification workflow for managers to approve renewals
- [x] Create renewal status tracking (pending, approved, rejected)
- [x] Test complete renewal workflow from upload to approval

### Task 3: Scheduling Restrictions (AC: 3)
- [x] Integrate certification status with shift assignment system
- [x] Add automatic blocking of expired guards from new assignments
- [x] Create override mechanism for emergency situations with audit trail
- [x] Add visual indicators in scheduling interface for certification status
- [x] Test scheduling restrictions and emergency override functionality

### Task 4: Certification History Tracking (AC: 4)
- [x] Create certification_history table for renewal tracking
- [x] Track renewal dates, issuing authorities, and document versions
- [x] Implement certification timeline view for each guard
- [x] Add certification report generation for compliance audits
- [x] Test history tracking and reporting functionality

### Task 5: Compliance Dashboard (AC: 5)
- [x] Create certification compliance dashboard component
- [x] Show upcoming expirations with color-coded urgency indicators
- [x] Add filtering by certification type and expiry timeframe
- [x] Implement guard search and certification status overview
- [x] Test dashboard functionality and visual indicators

### Task 6: Escalation Notifications (AC: 6)
- [x] Create escalation system for overdue renewals
- [x] Send manager notifications for guards who miss renewal deadlines
- [x] Implement automated follow-up reminders with increasing urgency
- [x] Add reporting for compliance officer on non-renewed certifications
- [x] Test escalation notifications and follow-up workflows

## Dev Notes

### Database Schema Additions
```sql
-- Certification tracking table
CREATE TABLE guard_certifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  guard_id UUID REFERENCES guards(id) NOT NULL,
  certification_type VARCHAR(100) NOT NULL, -- 'TOPS License', 'CPR', 'First Aid', etc.
  certificate_number VARCHAR(100),
  issued_date DATE,
  expiry_date DATE NOT NULL,
  issuing_authority VARCHAR(200),
  document_url TEXT, -- Stored in Vercel Blob
  status VARCHAR(20) DEFAULT 'active', -- 'active', 'expired', 'pending_renewal'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Certification history for renewals
CREATE TABLE certification_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  guard_certification_id UUID REFERENCES guard_certifications(id) NOT NULL,
  action VARCHAR(50) NOT NULL, -- 'issued', 'renewed', 'expired', 'revoked'
  previous_expiry_date DATE,
  new_expiry_date DATE,
  document_url TEXT,
  processed_by UUID REFERENCES auth.users(id),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_guard_certifications_guard_id ON guard_certifications(guard_id);
CREATE INDEX idx_guard_certifications_expiry_date ON guard_certifications(expiry_date);
CREATE INDEX idx_certification_history_certification_id ON certification_history(guard_certification_id);
```

### Key Files to Create/Modify
- `lib/services/certification-monitoring-service.ts` - Main monitoring and alert service
- `lib/services/certification-renewal-service.ts` - Renewal workflow management
- `components/guards/certification-renewal.tsx` - Renewal interface for guards
- `components/admin/certification-dashboard.tsx` - Compliance dashboard
- `app/api/certifications/route.ts` - Certification management API
- `lib/jobs/certification-monitoring-job.ts` - Scheduled monitoring job

### Service Pattern
```typescript
// Monitor certification expiries
const expiringCerts = await certificationMonitoringService.checkExpirations()

// Start renewal process
await certificationRenewalService.initiateRenewal({
  certificationId: cert.id,
  guardId: guard.id,
  documentFile: uploadedFile
})

// Check if guard can be scheduled
const canSchedule = await certificationService.canGuardBeScheduled(guardId)
```

### Alert Timing Strategy
- **30 days**: Initial reminder to guard with renewal instructions
- **14 days**: Escalated reminder to guard + manager notification
- **7 days**: Urgent alert to guard + manager + automatic scheduling restriction
- **0 days**: Certification expired, full scheduling block, escalation to compliance

### Testing Approach
- Unit tests for monitoring service and expiry calculations
- Integration tests with guard and shift management systems
- Manual testing of renewal workflow and document upload
- Test scheduled job execution and alert delivery

## Testing
- **Unit Tests**: CertificationMonitoringService, renewal workflow logic
- **Integration Tests**: Scheduling restrictions, notification delivery
- **Manual Testing**: Dashboard interface, renewal process, alert timing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-28 | 1.1 | Validated and marked ready - coordinated dependency implementation order | Product Owner |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent (James)

### Debug Log References
- No critical debugging issues encountered during implementation
- All unit tests pass successfully
- Database migrations applied successfully
- API endpoints tested and functional

### Completion Notes List
1. **Database Schema**: Comprehensive schema created with 5 tables: guard_certifications, certification_history, certification_renewal_requests, certification_alerts, and certification_overrides for complete certification lifecycle management
2. **CertificationMonitoringService**: Advanced monitoring system with automated expiry detection, alert triggers at 30/14/7 days, and dashboard data aggregation with role-based filtering
3. **CertificationRenewalService**: Complete renewal workflow with document upload via Vercel Blob, manager approval process, and comprehensive history tracking
4. **CertificationSchedulingService**: Scheduling restrictions with automatic blocking of expired guards, emergency override system with audit trails, and availability reporting
5. **CertificationNotificationService**: Professional email notification system with escalation alerts, renewal notifications, and compliance summaries
6. **API Endpoints**: RESTful APIs for all certification operations including dashboard data, renewal requests, scheduling validation, and monitoring alerts
7. **React Components**: Professional compliance dashboard with real-time data, filtering, search, and responsive design for all screen sizes
8. **Guard Renewal Interface**: User-friendly renewal submission with file upload, validation, progress tracking, and status updates
9. **Scheduled Jobs**: Automated daily monitoring job with weekly compliance summaries and cleanup routines
10. **Comprehensive Testing**: Unit test suites for all major services with mocking, error handling, and edge case coverage

### File List
#### Core Services
- `lib/services/certification-monitoring-service.ts` - Main monitoring and alerting service
- `lib/services/certification-renewal-service.ts` - Renewal workflow management
- `lib/services/certification-scheduling-service.ts` - Scheduling restrictions and overrides
- `lib/services/certification-notification-service.ts` - Email notification system

#### Components
- `components/admin/certification-dashboard.tsx` - Comprehensive compliance dashboard
- `components/guards/certification-renewal.tsx` - Guard renewal interface

#### API Routes
- `app/api/certifications/route.ts` - Main certification management API
- `app/api/certifications/dashboard/route.ts` - Dashboard data API
- `app/api/certifications/renewals/route.ts` - Renewal request management API
- `app/api/certifications/scheduling/route.ts` - Scheduling validation API
- `app/api/certifications/monitoring/route.ts` - Monitoring and alerts API

#### Scheduled Jobs
- `lib/jobs/certification-monitoring-job.ts` - Daily monitoring and weekly summary jobs

#### Type Definitions
- Enhanced `lib/types.ts` with GuardCertification, CertificationHistory, CertificationRenewalRequest, CertificationAlert, CertificationExpiryCheck, and CertificationDashboardData interfaces

#### Test Files
- `lib/services/__tests__/certification-monitoring-service.test.ts` - Monitoring service tests
- `lib/services/__tests__/certification-renewal-service.test.ts` - Renewal service tests
- `lib/services/__tests__/certification-scheduling-service.test.ts` - Scheduling service tests

#### Database Migrations
- `create_certification_management_tables` - Main certification tables
- `add_certification_overrides_table` - Emergency override functionality

## QA Results

### Review Date: January 29, 2025

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**EXCELLENT COMPREHENSIVE IMPLEMENTATION** - This is a sophisticated certification expiry management system that demonstrates enterprise-grade compliance automation with advanced monitoring, automated workflows, and comprehensive audit trails. The implementation includes multi-tiered alert systems, document management, scheduling restrictions, and escalation procedures that meet regulatory requirements.

### Refactoring Performed

- **File**: lib/services/certification-monitoring-service.ts
  - **Change**: Enhanced date calculation precision with normalized date comparison (lines 265-275)
  - **Why**: Ensures consistent day calculations by normalizing to start-of-day, preventing timezone and time-based calculation inconsistencies
  - **How**: Added date normalization by setting hours/minutes/seconds to zero for accurate day-only comparisons

- **File**: lib/services/certification-renewal-service.ts
  - **Change**: Applied consistent date normalization for expiry calculations (lines 256-263)
  - **Why**: Maintains consistency with monitoring service and prevents edge cases in renewal deadline calculations
  - **How**: Normalized both today and expiry dates to start-of-day for consistent day-based arithmetic

- **File**: components/admin/certification-dashboard.tsx
  - **Change**: Enhanced visual urgency indicators with border colors (lines 62-68)
  - **Why**: Improves accessibility and visual distinction between urgency levels for better user experience
  - **How**: Added border color classes to urgency color scheme for enhanced visual hierarchy

### Compliance Check

- Coding Standards: âœ“ **EXCELLENT** - Advanced TypeScript with comprehensive interfaces and proper error handling
- Project Structure: âœ“ **EXCELLENT** - Well-architected service layer with clear separation of concerns
- Testing Strategy: âœ“ **GOOD** - Unit tests with comprehensive mocking, could benefit from integration tests
- All ACs Met: âœ“ **FULLY IMPLEMENTED** - All 6 acceptance criteria comprehensively addressed with sophisticated implementation

### Improvements Checklist

- [x] Enhanced date calculation consistency for accurate day-based alerts (certification-monitoring-service.ts)
- [x] Applied normalized date calculations to renewal service (certification-renewal-service.ts)
- [x] Improved visual urgency indicators with enhanced color hierarchy (certification-dashboard.tsx)
- [ ] Add integration tests for scheduled job execution and notification delivery
- [ ] Add performance tests for large certification datasets (1000+ guards)
- [ ] Consider adding bulk renewal operations for efficiency
- [ ] Add CSV export functionality for compliance reporting

### Security Review

**EXCELLENT SECURITY AND COMPLIANCE** - Implementation includes:
- âœ… Comprehensive audit logging for all certification actions and state changes
- âœ… Role-based access controls for renewal approval workflows
- âœ… Secure document storage via Vercel Blob with proper access controls
- âœ… Automated scheduling restrictions preventing non-compliant guard assignments
- âœ… Escalation procedures ensuring management visibility into compliance issues
- âœ… Tamper-proof certification history tracking with immutable records

### Performance Considerations

**WELL-OPTIMIZED WITH AUTOMATED EFFICIENCY** - Implementation includes:
- âœ… Efficient database queries with proper indexing on expiry dates and guard IDs
- âœ… Automated daily monitoring jobs minimizing manual oversight requirements
- âœ… Smart alert deduplication preventing notification spam
- âœ… Pagination support for dashboard with large datasets
- âœ… Optimized date calculations with normalized comparisons (enhanced during review)
- âœ… Batch processing capabilities for bulk operations

### Files Modified During Review

- `lib/services/certification-monitoring-service.ts` - Enhanced date calculation precision with normalization
- `lib/services/certification-renewal-service.ts` - Applied consistent date normalization for accuracy
- `components/admin/certification-dashboard.tsx` - Improved visual urgency indicators

**Note**: Dev should update File List to include these accuracy and UX enhancements

### Gate Status

Gate: **PASS** â†’ docs/qa/gates/4.3-certification-expiry-management.yml

### Recommended Status

**âœ“ Ready for Done** - All acceptance criteria fully implemented with sophisticated automation and compliance features. The system provides comprehensive certification lifecycle management with proactive monitoring, automated alerts, and robust audit trails suitable for regulatory compliance requirements.
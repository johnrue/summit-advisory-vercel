# Story 0.2: Mock Data Integration Replacement

## Status
🔄 **IN PROGRESS** - Story created and ready for implementation. Technical specifications complete with systematic mock data replacement strategy and live Supabase backend integration approach.

## Story
**As a** development team,
**I want** to replace all 60+ identified mock data instances with live Supabase backend integrations,
**so that** the Guard Management Platform operates with real data persistence and achieves production-ready functionality.

## Acceptance Criteria
1. **Replace all API endpoints with live Supabase integration**:
   - All API routes return live data from Supabase database
   - No placeholder responses or hardcoded mock data in API endpoints
   - Proper error handling for database connection and query failures
   - Authentication integration with Supabase Auth for all protected endpoints

2. **Connect all components to real backend services**:
   - All dashboard components consume live API endpoints
   - No hardcoded mock data arrays in component code
   - Real-time data updates using Supabase subscriptions where applicable
   - Proper loading states and error handling for data fetching

3. **Eliminate all mock data in production code paths**:
   - Zero instances of "Mock data", "placeholder", "// For now" comments in production files
   - All CRUD operations functional with database persistence
   - Data validation and sanitization at API and database levels
   - Proper audit trail implementation for all data changes

4. **Establish production-ready data architecture**:
   - Complete Supabase RLS (Row Level Security) policies implementation
   - Database schema aligned with application data models
   - Performance optimization for data queries and real-time subscriptions
   - Data backup and recovery procedures documented

## Tasks / Subtasks

- [ ] Task 1: Authentication System Integration (AC: 1, 4) 🔄 **IN PROGRESS**
  - [ ] Replace mock authentication in `lib/auth.ts` with Supabase Auth
  - [ ] Implement JWT token validation and role-based access control
  - [ ] Create user session management with proper token refresh
  - [ ] Integrate authentication middleware for API routes
  - [ ] Test authentication flows for all user roles (Guard, Manager, Admin)

- [ ] Task 2: Core API Endpoints - Lead Management (AC: 1, 3) 📋 **PLANNED**
  - [ ] Replace mock responses in `/api/v1/leads/**` endpoints
  - [ ] Implement live lead CRUD operations with Supabase
  - [ ] Add lead assignment and status update functionality
  - [ ] Create lead analytics endpoints with real-time data
  - [ ] Implement lead follow-up and notification triggers

- [ ] Task 3: Core API Endpoints - Application Management (AC: 1, 3) 📋 **PLANNED**
  - [ ] Replace mock responses in `/api/v1/applications/**` endpoints
  - [ ] Implement guard application CRUD with document storage
  - [ ] Add AI resume parsing integration with OpenAI
  - [ ] Create application workflow and status management
  - [ ] Implement background check integration and tracking

- [ ] Task 4: Core API Endpoints - Contract & Project Management (AC: 1, 3) 📋 **PLANNED**
  - [ ] Replace mock responses in `/api/v1/contracts/**` endpoints
  - [ ] Implement contract lifecycle management with Supabase
  - [ ] Add project management CRUD operations (`/api/v1/projects/**`)
  - [ ] Create contract analytics and revenue tracking
  - [ ] Implement document management and electronic signatures

- [ ] Task 5: Core API Endpoints - Shift & Schedule Management (AC: 1, 3) 📋 **PLANNED**
  - [ ] Replace mock responses in `/api/v1/shifts/**` endpoints
  - [ ] Implement shift creation, assignment, and management
  - [ ] Add calendar integration with real-time updates
  - [ ] Create availability management and time-off requests
  - [ ] Implement shift analytics and reporting

- [ ] Task 6: Service Layer Integration (AC: 2, 3) 📋 **PLANNED**
  - [ ] Update all services in `lib/services/*.ts` to use Supabase
  - [ ] Replace hardcoded arrays with database queries
  - [ ] Implement proper error handling and data validation
  - [ ] Add caching strategies for frequently accessed data
  - [ ] Create service layer unit tests with real database integration

- [ ] Task 7: Component Data Integration (AC: 2) 📋 **PLANNED**
  - [ ] Update dashboard components to consume live APIs
  - [ ] Replace mock data in Kanban boards with real-time updates
  - [ ] Implement live analytics charts with actual data
  - [ ] Add proper loading states and error handling to all components
  - [ ] Create real-time subscription management for live updates

- [ ] Task 8: Database Schema & RLS Implementation (AC: 4) 📋 **PLANNED**
  - [ ] Validate database schema alignment with application models
  - [ ] Implement comprehensive RLS policies for all tables
  - [ ] Create database indexes for performance optimization
  - [ ] Set up database backup and recovery procedures
  - [ ] Implement audit trail and change tracking for all operations

## Dev Notes

### Mock Data Assessment
From comprehensive codebase analysis of 110+ affected files:

**Critical Mock Data Locations:**
1. **Authentication System** (`lib/auth.ts`):
   ```typescript
   // Current mock implementation:
   const mockUser = {
     userId: 'mock-user-id',
     role: 'manager',
     email: 'manager@summitadvisory.com'
   }
   ```

2. **API Endpoints** (60+ endpoints):
   ```typescript
   // Example from app/api/compliance-reports/route.ts:
   const mockReports = [
     {
       id: 'report-1',
       type: 'tops_compliance',
       // ... hardcoded mock data
     }
   ]
   ```

3. **Service Layers** (25+ services):
   ```typescript
   // Services returning hardcoded arrays instead of database queries
   // Missing Supabase integration in lib/services/*.ts files
   ```

4. **Dashboard Components** (15+ components):
   ```typescript
   // Components with hardcoded mock data for charts and tables
   // Missing real-time subscription integration
   ```

### Supabase Integration Strategy
**Database Schema Requirements:**
Based on completed Story 0.1 type definitions and Epic 1-5 requirements:

```sql
-- Core user management
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  role user_role NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Lead management (from Epic 5)
CREATE TABLE client_leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source lead_source NOT NULL,
  status lead_status NOT NULL,
  assigned_manager UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Guard applications (from Epic 2)
CREATE TABLE guard_applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  applicant_email VARCHAR(255) NOT NULL,
  status application_status NOT NULL,
  resume_data JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Contract management (from Epic 5)
CREATE TABLE contracts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  client_id UUID REFERENCES client_leads(id),
  status contract_status NOT NULL,
  value DECIMAL(10,2),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Shift management (from Epic 3)
CREATE TABLE shifts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  start_time TIMESTAMPTZ NOT NULL,
  end_time TIMESTAMPTZ NOT NULL,
  assigned_guard UUID REFERENCES users(id),
  status shift_status NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Internal projects (from Epic 5)
CREATE TABLE internal_projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  status project_status NOT NULL,
  owner_id UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

**RLS Policies Strategy:**
```sql
-- Role-based access control
ALTER TABLE client_leads ENABLE ROW LEVEL SECURITY;

-- Managers can access leads assigned to them
CREATE POLICY "managers_own_leads" ON client_leads
  FOR ALL TO authenticated
  USING (
    assigned_manager = auth.uid() OR
    EXISTS (
      SELECT 1 FROM users 
      WHERE id = auth.uid() AND role = 'admin'
    )
  );

-- Guards can only access their own data
CREATE POLICY "guards_own_data" ON guard_applications
  FOR SELECT TO authenticated
  USING (
    applicant_email = (SELECT email FROM users WHERE id = auth.uid())
  );
```

### Integration Phases
**Phase 1: Authentication Foundation (Day 1)**
```typescript
// Replace lib/auth.ts mock implementation:
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs'

export async function validateRequestAuth(
  request: NextRequest,
  requiredRoles: string[] = []
): Promise<AuthResult> {
  const supabase = createServerComponentClient({ cookies })
  const { data: { session } } = await supabase.auth.getSession()
  
  if (!session) {
    return { success: false, error: 'Unauthorized', status: 401 }
  }
  
  // Implement role-based validation
  // Return actual user data from database
}
```

**Phase 2: Core API Integration (Day 2-3)**
```typescript
// Update API endpoints to use Supabase:
export async function GET(request: NextRequest) {
  const supabase = createServerComponentClient({ cookies })
  
  // Replace mock data with real queries:
  const { data: leads, error } = await supabase
    .from('client_leads')
    .select('*')
    .order('created_at', { ascending: false })
    
  if (error) {
    return NextResponse.json(
      { error: 'Failed to fetch leads' },
      { status: 500 }
    )
  }
  
  return NextResponse.json({ data: leads })
}
```

**Phase 3: Service Layer Integration (Day 3-4)**
```typescript
// Update service classes to use Supabase:
export class LeadManagementService {
  static async createLead(leadData: CreateLeadRequest): Promise<ClientLead> {
    const supabase = createServerComponentClient({ cookies })
    
    const { data, error } = await supabase
      .from('client_leads')
      .insert(leadData)
      .select()
      .single()
      
    if (error) throw new Error(`Failed to create lead: ${error.message}`)
    return data
  }
}
```

**Phase 4: Component Integration (Day 4)**
```typescript
// Update components to consume live APIs:
export default function LeadsKanbanBoard() {
  const [leads, setLeads] = useState<ClientLead[]>([])
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    fetchLeads()
  }, [])
  
  const fetchLeads = async () => {
    try {
      const response = await fetch('/api/v1/leads')
      const { data } = await response.json()
      setLeads(data)
    } catch (error) {
      console.error('Failed to fetch leads:', error)
    } finally {
      setLoading(false)
    }
  }
  
  // Real-time subscription integration:
  useEffect(() => {
    const supabase = createClientComponentClient()
    
    const subscription = supabase
      .channel('leads-changes')
      .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'client_leads' },
          (payload) => {
            // Update leads state with real-time changes
          }
      )
      .subscribe()
      
    return () => { subscription.unsubscribe() }
  }, [])
}
```

### Technology Stack Integration
**Supabase Integration Requirements:**
- **@supabase/supabase-js**: Client library for database operations
- **@supabase/auth-helpers-nextjs**: Next.js authentication integration
- **Real-time subscriptions**: Live data updates for collaborative features
- **Storage integration**: File uploads and document management

**Environment Variables Required:**
```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

**Performance Considerations:**
- Database connection pooling and query optimization
- Caching strategies for frequently accessed data
- Real-time subscription management and cleanup
- Efficient data fetching patterns to prevent over-fetching

### Story 0.1 Integration
**Building on TypeScript Foundation:**
- Leverage completed type definitions from Story 0.1
- Use standardized interfaces for database models
- Implement type-safe API responses and service methods
- Maintain zero TypeScript errors during mock data replacement

**Dependency Chain:**
- Story 0.1 (TypeScript) → Story 0.2 (Mock Data) → Story 0.3 (Testing) → Story 0.4 (Production)
- Type safety enables reliable mock data replacement
- Live data integration enables comprehensive testing
- Production deployment requires both type safety and real data

### Marketing Site Preservation
**Isolated Implementation:**
- All changes focused on guard management platform (`/dashboard`, `/app/api/v1/`)
- Marketing site consultation requests (`/api/consultation`) preserved
- Static export functionality for marketing pages maintained
- No changes to marketing components or services

## Testing

**Test File Locations** [Source: testing-strategy.md]:
- Database integration tests: `__tests__/database/` directory
- API endpoint tests: `__tests__/api/v1/**/*.test.ts` files  
- Service integration tests: `__tests__/services/*.test.ts` files
- Component integration tests: `__tests__/components/**/*.test.ts` files

**Testing Strategy**:
- **Database Testing**: Test Supabase integration with test database
- **API Integration Testing**: Validate all endpoints with real database
- **Service Layer Testing**: Test business logic with live data operations
- **Component Testing**: Validate UI components with live API integration

**Coverage Requirements**:
- **API Endpoints**: 100% mock data elimination validation
- **Service Methods**: All CRUD operations tested with real database
- **Component Integration**: All data-consuming components tested with live APIs

**Specific Testing Requirements for This Story**:
- Validate zero mock data instances remain in production code paths
- Test all API endpoints return live data from Supabase
- Verify authentication integration across all protected endpoints
- Test real-time subscriptions and live data updates
- Validate RLS policies prevent unauthorized data access
- Test error handling for database connection and query failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation building on completed Story 0.1 foundation | Scrum Master |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent

### Architecture Context Loaded
- **Epic 0 Technical Debt Resolution**: Building on completed Story 0.1 TypeScript foundation
- **Supabase Integration**: Comprehensive backend integration strategy
- **Mock Data Analysis**: Assessment of 110+ affected files with mock data usage
- **Database Schema Design**: Integration with Epic 1-5 requirements and completed type definitions

### Technical Specifications
**Mock Data Replacement Strategy**:
- Systematic replacement in dependency order: Auth → APIs → Services → Components
- Supabase integration with RLS policies and real-time subscriptions
- Type-safe implementation leveraging Story 0.1 completed type definitions
- Performance optimization with caching and efficient query patterns

**Key Dependencies**:
- **Story 0.1 Completion**: TypeScript error resolution and type definitions
- **Supabase Setup**: Database schema, RLS policies, and authentication configuration
- **Environment Configuration**: Supabase connection variables and service keys
- **Testing Database**: Separate test environment for integration testing

**Database Design**:
- Comprehensive schema aligned with Epic 1-5 requirements
- RLS policies for role-based access control (Guard, Manager, Admin)
- Audit trail implementation for all data operations
- Performance optimization with proper indexing and query patterns

**Security Architecture**:
- Supabase Auth integration replacing mock authentication
- Role-based access control with RLS policies
- JWT token validation and session management
- Secure API endpoints with proper authentication middleware

### File Organization Strategy
Following Epic 0 patterns and building on Story 0.1:
- Authentication: `lib/auth.ts` Supabase Auth integration
- API endpoints: `app/api/v1/**/*.ts` live database integration
- Service layer: `lib/services/*.ts` Supabase client integration
- Components: `components/dashboard/**/*.tsx` live API consumption
- Database: `supabase/` schema, migrations, and RLS policies

## QA Results

### Quality Gate Assessment: PENDING ⏳
**Score: TBD** | **Reviewer: TBD** | **Date: Pending**

#### Executive Summary
Story 0.2 provides comprehensive mock data replacement with live Supabase backend integration, building on the solid TypeScript foundation established by completed Story 0.1. The story transforms the platform from sophisticated demo to production-ready application with real data persistence.

#### Implementation Status
- ✅ **Story Specification**: Complete with systematic replacement strategy and 8 detailed implementation tasks
- ⏳ **Implementation**: Pending development team assignment
- ⏳ **Quality Assessment**: Awaiting implementation completion
- ⏳ **Production Readiness**: Pending mock data elimination and database integration

#### Key Features Specified
1. **Complete Authentication Integration** - Replace mock auth with Supabase Auth and JWT validation
2. **Live API Endpoints** - All 60+ API routes connected to real Supabase database
3. **Real-time Data Updates** - Supabase subscriptions for collaborative features
4. **Comprehensive RLS Policies** - Role-based security at database level
5. **Service Layer Integration** - All business logic connected to live database
6. **Component Live Data** - All dashboard components consuming real APIs

#### Production Blockers: TBD ⏳
Pending implementation and mock data elimination completion.

---
*Quality gate pending implementation completion*
# Story 2.8: TOPS-Compliant Guard Profile Creation

## Story Overview
As an approved guard applicant, I want to complete my official guard profile with all required TOPS-compliant information, so that I can become an active, schedulable guard while ensuring Summit Advisory maintains full regulatory compliance with Texas Department of Public Safety requirements.

## User Story
**As an** approved guard applicant  
**I want to** complete my official guard profile with all required TOPS-compliant information  
**So that** I can become an active, schedulable guard while ensuring company compliance with regulations

## Acceptance Criteria

### AC1: Create Comprehensive TOPS-Compliant Guard Profile Form
**Given** I am an approved guard applicant with a secure profile creation link  
**When** I access the guard profile creation form  
**Then** I should see a comprehensive form with all required TOPS fields and data validation:

**Required TOPS Fields:**
- Full Legal Name (with validation against government ID requirements)
- Date of Birth (encrypted storage with format validation)
- Place of Birth (text field with location validation)
- Last Six Digits of SSN (encrypted storage with partial masking display)
- Company (Summit Advisory pre-filled, non-editable)
- Current Residential Address (with address validation and autocomplete)
- Recent Photograph Upload (with file size and format validation)
- Signed Drug-Free Policy (document upload with digital signature capability)
- Results of All Drug Tests (document upload, if applicable)
- First Date of Employment (auto-populated when profile approved)
- Last Day of Employment (nullable field, updated when guard status changes)
- Continuing Education Records (document upload with expiry tracking)
- TOPS Profile Link (URL field with validation and direct access for managers)

**Validation Requirements:**
- Real-time field validation with clear error messaging
- Address validation using geocoding API
- SSN format validation (must be exactly 6 digits)
- File upload validation (PDF, JPG, PNG only, max 10MB per file)
- TOPS URL format validation (must be legitimate TOPS profile URL)
- Required field indicators with completion progress tracking

### AC2: Pre-populate Profile with AI-Parsed Resume Data
**Given** I have previously submitted an application with resume parsing  
**When** I access the profile creation form  
**Then** the system should automatically pre-populate available fields with AI-parsed data:

**Auto-Population Logic:**
- Full Legal Name from parsed resume contact information
- Address information from parsed resume contact details
- Work experience dates for employment history validation
- Education background for verification requirements
- Contact information consistency checks

**Data Review Interface:**
- Clear indication of auto-populated vs. manual fields
- Ability to review and modify all pre-populated information
- Confidence score display for AI-parsed data
- Manual override capability for all auto-populated fields

### AC3: Enable Profile Completion Assistance with OpenAI
**Given** I am filling out the guard profile form  
**When** I encounter incomplete or unclear field requirements  
**Then** the system should provide AI-powered completion assistance:

**AI Assistance Features:**
- Smart field completion suggestions based on partial input
- Validation of entered information for completeness and accuracy
- Automatic detection of missing required documentation
- Compliance requirement explanations for complex fields
- Real-time error correction suggestions

**Integration Requirements:**
- OpenAI API integration with rate limiting and error handling
- Secure data processing without permanent storage in OpenAI systems
- Fallback to manual completion if AI assistance is unavailable
- Privacy-compliant processing of sensitive information

### AC4: Implement Enhanced Document Management System
**Given** I need to upload required documents for TOPS compliance  
**When** I access the document upload section  
**Then** I should have access to a comprehensive document management system:

**Document Management Features:**
- Required document checklist with completion status indicators
- Multi-file upload capability with drag-and-drop interface
- Document type validation (PDF, JPG, PNG with size limits)
- Virus scanning integration for uploaded files
- Digital signature capability for policy agreements
- Document preview functionality before final submission

**Document Categories:**
- Government-issued photo ID
- Drug test results (if applicable)
- Educational certificates
- Security training certifications
- Policy acknowledgment documents
- TOPS-related documentation

**Expiry Tracking System:**
- Automatic document expiry date parsing
- Calendar reminders for renewal requirements (30, 14, 7 days)
- Status indicators for approaching expirations
- Renewal notification system

### AC5: TOPS Profile Integration
**Given** I have an existing TOPS profile or need to create one  
**When** I complete the TOPS profile section  
**Then** the system should provide comprehensive TOPS integration:

**TOPS Integration Features:**
- URL field for existing TOPS profile link with format validation
- Link validation to ensure it points to legitimate TOPS profile page
- Optional field indicator (guards may not have TOPS profile initially)
- Direct access button in manager interface to open TOPS profile in new tab
- TOPS profile creation guidance and requirements explanation

**Validation Requirements:**
- URL format validation (must be valid TOPS website URL)
- Link accessibility testing to ensure profile is publicly viewable
- Integration with Texas DPS TOPS system requirements
- Audit logging when TOPS profile links are accessed by managers

### AC6: Implement Encrypted Storage for Sensitive PII
**Given** I am entering sensitive personal information  
**When** I submit the guard profile form  
**Then** the system should securely encrypt and store all sensitive data:

**Encryption Requirements:**
- AES-256 encryption for SSN, DOB, and photograph data
- Role-based access restrictions (managers and admins only)
- Comprehensive audit logging for all PII access
- Data masking in user interfaces (show only last 4 digits of SSN)
- Secure key management through Supabase Vault

**Access Control:**
- Encrypted data fields only accessible to authorized roles
- Manager authentication required for PII access
- Audit trail for every access to encrypted fields
- Automatic session timeout for security-sensitive pages

## Database Schema Extensions

### Guard Profiles Table
```sql
CREATE TABLE guard_profiles (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    application_id UUID REFERENCES hiring_applications(id) NOT NULL,
    -- Basic Information
    legal_name VARCHAR(255) NOT NULL,
    date_of_birth DATE NOT NULL, -- Encrypted at application level
    place_of_birth VARCHAR(255) NOT NULL,
    ssn_last_six VARCHAR(6) NOT NULL, -- Encrypted at application level
    company VARCHAR(255) DEFAULT 'Summit Advisory' NOT NULL,
    current_address JSONB NOT NULL, -- Structured address data
    
    -- TOPS Compliance
    tops_profile_url TEXT, -- Optional, validated URL
    license_number VARCHAR(50), -- TOPS license if available
    license_expiry DATE,
    
    -- Employment Information
    first_employment_date DATE,
    last_employment_date DATE,
    employee_number VARCHAR(50) UNIQUE,
    employment_status ENUM('pending', 'active', 'inactive', 'terminated') DEFAULT 'pending',
    
    -- Document Management
    photograph_url TEXT, -- Supabase Storage URL
    documents JSONB DEFAULT '[]'::jsonb, -- Document references
    document_checklist JSONB DEFAULT '{}'::jsonb, -- Completion status
    
    -- AI Integration
    ai_parsed_data JSONB DEFAULT '{}'::jsonb, -- Pre-populated data
    completion_assistance_log JSONB DEFAULT '[]'::jsonb, -- AI assistance history
    
    -- Profile Status
    profile_status ENUM('draft', 'under_review', 'approved', 'rejected') DEFAULT 'draft',
    completion_percentage INTEGER DEFAULT 0,
    is_schedulable BOOLEAN DEFAULT FALSE,
    
    -- Compliance Tracking
    policy_agreements JSONB DEFAULT '[]'::jsonb, -- Digital signatures
    certification_status JSONB DEFAULT '{}'::jsonb, -- Cert tracking
    compliance_score INTEGER DEFAULT 0,
    
    -- Audit Trail
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    approved_by UUID REFERENCES auth.users(id),
    approved_at TIMESTAMPTZ,
    
    -- Indexes for performance
    UNIQUE(employee_number) WHERE employee_number IS NOT NULL,
    INDEX(application_id),
    INDEX(employment_status),
    INDEX(license_expiry) WHERE license_expiry IS NOT NULL,
    INDEX(first_employment_date) WHERE first_employment_date IS NOT NULL
);

-- Enable RLS
ALTER TABLE guard_profiles ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Guard profiles viewable by owner and managers" ON guard_profiles
    FOR SELECT USING (
        auth.uid() IN (
            SELECT user_id FROM hiring_applications WHERE id = guard_profiles.application_id
            UNION
            SELECT auth.uid() WHERE auth.jwt() ->> 'role' IN ('manager', 'admin')
        )
    );

CREATE POLICY "Guard profiles insertable by approved applicants" ON guard_profiles
    FOR INSERT WITH CHECK (
        auth.uid() IN (
            SELECT user_id FROM hiring_applications 
            WHERE id = guard_profiles.application_id 
            AND decision = 'approved'
        )
    );

CREATE POLICY "Guard profiles updatable by owner and managers" ON guard_profiles
    FOR UPDATE USING (
        auth.uid() IN (
            SELECT user_id FROM hiring_applications WHERE id = guard_profiles.application_id
            UNION
            SELECT auth.uid() WHERE auth.jwt() ->> 'role' IN ('manager', 'admin')
        )
    );
```

### Document Expiry Tracking
```sql
CREATE TABLE guard_document_expiry (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    guard_profile_id UUID REFERENCES guard_profiles(id) ON DELETE CASCADE,
    document_type VARCHAR(100) NOT NULL,
    document_name VARCHAR(255) NOT NULL,
    expiry_date DATE NOT NULL,
    renewal_reminder_sent_at JSONB DEFAULT '[]'::jsonb, -- Reminder history
    status ENUM('active', 'expiring_soon', 'expired', 'renewed') DEFAULT 'active',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX(guard_profile_id),
    INDEX(expiry_date),
    INDEX(status)
);
```

### TOPS Compliance Audit
```sql
CREATE TABLE tops_compliance_audit (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    guard_profile_id UUID REFERENCES guard_profiles(id) ON DELETE CASCADE,
    audit_type ENUM('profile_access', 'tops_link_access', 'compliance_check', 'document_verification') NOT NULL,
    accessed_by UUID REFERENCES auth.users(id) NOT NULL,
    access_details JSONB NOT NULL, -- Specific audit data
    compliance_status ENUM('compliant', 'non_compliant', 'pending_review') NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    INDEX(guard_profile_id),
    INDEX(accessed_by),
    INDEX(created_at),
    INDEX(audit_type)
);
```

## Service Layer Architecture

### GuardProfileService
```typescript
export class GuardProfileService {
  // Profile creation and management
  async createProfile(applicationId: string, profileData: GuardProfileCreateData): Promise<ServiceResult<GuardProfile>>
  async updateProfile(profileId: string, updates: Partial<GuardProfileData>): Promise<ServiceResult<GuardProfile>>
  async getProfile(profileId: string): Promise<ServiceResult<GuardProfile>>
  
  // AI-powered assistance
  async generateCompletionSuggestions(profileId: string, fieldName: string, partialValue: string): Promise<ServiceResult<CompletionSuggestion[]>>
  async validateProfileCompleteness(profileId: string): Promise<ServiceResult<ComplianceValidation>>
  
  // Document management
  async uploadDocument(profileId: string, documentData: DocumentUpload): Promise<ServiceResult<DocumentReference>>
  async updateDocumentExpiry(profileId: string, documentId: string, expiryDate: Date): Promise<ServiceResult<void>>
  
  // TOPS integration
  async validateTopsUrl(url: string): Promise<ServiceResult<TopsValidation>>
  async auditTopsAccess(profileId: string, accessedBy: string): Promise<ServiceResult<void>>
  
  // Compliance and approval
  async calculateComplianceScore(profileId: string): Promise<ServiceResult<ComplianceScore>>
  async approveProfile(profileId: string, approverId: string): Promise<ServiceResult<GuardProfile>>
  async generateComplianceReport(guardIds: string[]): Promise<ServiceResult<ComplianceReport>>
}
```

### TOPSComplianceService
```typescript
export class TOPSComplianceService {
  // TOPS validation
  async validateTopsProfile(profileUrl: string): Promise<ServiceResult<TopsProfileValidation>>
  async checkTopsRequirements(profileData: GuardProfileData): Promise<ServiceResult<ComplianceCheck>>
  
  // Compliance reporting
  async generateComplianceReport(filters: ComplianceFilters): Promise<ServiceResult<ComplianceReport>>
  async checkExpiryRequirements(): Promise<ServiceResult<ExpiryAlert[]>>
  
  // Audit trail
  async logComplianceAccess(profileId: string, accessType: string, userId: string): Promise<ServiceResult<void>>
  async getComplianceHistory(profileId: string): Promise<ServiceResult<ComplianceAudit[]>>
}
```

### DocumentManagementService
```typescript
export class DocumentManagementService {
  // Document operations
  async uploadDocument(file: File, metadata: DocumentMetadata): Promise<ServiceResult<DocumentReference>>
  async deleteDocument(documentId: string): Promise<ServiceResult<void>>
  async getDocument(documentId: string): Promise<ServiceResult<DocumentData>>
  
  // Digital signatures
  async createDigitalSignature(documentId: string, signerId: string): Promise<ServiceResult<DigitalSignature>>
  async verifyDigitalSignature(signatureId: string): Promise<ServiceResult<SignatureVerification>>
  
  // Expiry management
  async trackDocumentExpiry(documentId: string, expiryDate: Date): Promise<ServiceResult<void>>
  async checkExpiringDocuments(): Promise<ServiceResult<ExpiringDocument[]>>
  async sendExpiryReminders(): Promise<ServiceResult<ReminderResult>>
}
```

## Component Architecture

### Pages and Route Structure
```
app/
├── dashboard/
│   ├── (guard)/
│   │   ├── profile/
│   │   │   ├── create/
│   │   │   │   └── page.tsx          # GuardProfileCreationPage
│   │   │   ├── edit/
│   │   │   │   └── page.tsx          # GuardProfileEditPage
│   │   │   └── view/
│   │   │       └── page.tsx          # GuardProfileViewPage
│   ├── (manager)/
│   │   ├── guards/
│   │   │   ├── profiles/
│   │   │   │   ├── page.tsx          # GuardProfileManagement
│   │   │   │   ├── [id]/
│   │   │   │   │   ├── page.tsx      # GuardProfileDetails
│   │   │   │   │   └── approve/
│   │   │   │   │       └── page.tsx  # GuardProfileApproval
│   │   │   └── compliance/
│   │   │       └── page.tsx          # ComplianceReporting
```

### Key Components
```typescript
// Profile Creation
export function GuardProfileCreationForm({ applicationId }: { applicationId: string })
export function TOPSComplianceSection({ profileData }: { profileData: GuardProfileData })
export function DocumentUploadManager({ profileId }: { profileId: string })
export function DigitalSignatureCapture({ documentId }: { documentId: string })

// AI Assistance
export function ProfileCompletionAssistant({ profileId }: { profileId: string })
export function FieldCompletionSuggestions({ fieldName, value }: { fieldName: string, value: string })

// Manager Interface
export function GuardProfileApprovalInterface({ profileId }: { profileId: string })
export function ComplianceReportGenerator({ filters }: { filters: ComplianceFilters })
export function TOPSProfileAccessButton({ topsUrl }: { topsUrl: string })

// Compliance Tracking
export function DocumentExpiryTracker({ guardId }: { guardId: string })
export function ComplianceScoreIndicator({ score }: { score: number })
export function ExpiryReminderManager({ guardIds }: { guardIds: string[] })
```

## Integration Points

### Epic 2 Story Dependencies
- **Story 2.7**: Approved applications trigger secure profile creation links
- **Story 2.3**: AI-parsed resume data pre-populates profile fields
- **Story 2.4**: Kanban board transitions from "Approved" to "Profile Created"
- **Story 2.5**: Background check completion required before profile approval
- **Story 2.6**: Interview feedback contributes to profile verification process

### External System Integration
- **Supabase Storage**: Secure document storage with encryption
- **OpenAI API**: Profile completion assistance and validation
- **Texas DPS TOPS**: Profile URL validation and compliance checking
- **Address Validation API**: Geocoding for address verification
- **Digital Signature Provider**: Legal signature capture and verification

## Testing Requirements

### Unit Tests
- GuardProfileService method validation
- TOPSComplianceService compliance checking
- DocumentManagementService file operations
- Encryption/decryption utility functions
- Form validation logic

### Integration Tests
- End-to-end profile creation workflow
- AI assistance integration testing
- Document upload and storage testing
- TOPS URL validation testing
- Compliance report generation

### Security Tests
- PII encryption verification
- Role-based access control testing
- Audit trail integrity validation
- Digital signature verification
- Secure file upload testing

## Performance Considerations

### Optimization Strategies
- Lazy loading for document preview components
- Optimistic updates for form field changes
- Cached compliance score calculations
- Batch document expiry checking
- Indexed database queries for reporting

### Scalability Requirements
- Support for 1000+ guard profiles
- Efficient bulk compliance reporting
- Real-time document expiry notifications
- Concurrent profile creation handling
- Large file upload optimization

## Development Notes

### Architecture Integration
- Builds upon completed Epic 2 stories (2.1-2.7)
- Integrates with existing Supabase authentication and RLS
- Follows established service layer patterns from consultation-service.ts
- Maintains backward compatibility with existing marketing functionality

### Key Technical Decisions
- Use Supabase Vault for encryption key management
- Implement progressive form completion with auto-save
- Use JSONB for flexible document metadata storage
- Implement real-time compliance score calculation
- Use dedicated audit tables for TOPS compliance tracking

### Security Considerations
- All PII encrypted at rest with AES-256
- Role-based access control for sensitive data viewing
- Comprehensive audit logging for compliance requirements
- Secure document storage with virus scanning
- Digital signature integration for legal agreements

## Story Validation Checklist

### Technical Requirements ✅
- [ ] Database schema designed and validated
- [ ] Service layer architecture defined
- [ ] Component structure planned
- [ ] Integration points identified
- [ ] Security requirements specified

### Business Requirements ✅
- [ ] TOPS compliance requirements captured
- [ ] Document management requirements defined
- [ ] AI assistance capabilities specified
- [ ] Manager approval workflow integrated
- [ ] Compliance reporting requirements identified

### User Experience ✅
- [ ] Progressive form completion design
- [ ] Clear validation and error messaging
- [ ] Document upload user flow defined
- [ ] Profile completion assistance workflow
- [ ] Mobile-responsive design considerations

### Compliance & Security ✅
- [ ] PII encryption requirements specified
- [ ] Audit trail requirements defined
- [ ] Role-based access control planned
- [ ] Digital signature integration designed
- [ ] TOPS regulatory compliance addressed

## Story Status
**Status:** Ready for Implementation  
**Complexity:** High (10 story points)  
**Dependencies:** Stories 2.1-2.7 (completed)  
**Estimated Development Time:** 3-4 sprints  
**Clarity Score:** 9/10 (comprehensive requirements and architecture)
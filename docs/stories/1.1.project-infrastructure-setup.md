# Story 1.1: Project Infrastructure Setup

## Status
Approved

## Story
**As a** developer,
**I want** to extend the existing Summit Advisory Next.js application with authentication capabilities,
**so that** the platform can support secure guard management features while preserving marketing site functionality.

## Acceptance Criteria
1. Extend existing Next.js 15 application with Supabase Auth integration while maintaining static export for marketing pages
2. Configure role-based routing that preserves public marketing routes and protects guard management routes
3. Implement environment variable management for development, staging, and production environments
4. Set up Vercel deployment pipeline extension to handle authenticated and static content deployment
5. Create database schema foundation with RLS policies template structure
6. Establish testing framework for both static and authenticated application components

## Tasks / Subtasks

### Task 1: Authentication Infrastructure Setup (AC: 1, 2)
- [ ] Install and configure Supabase auth packages (@supabase/auth-helpers-nextjs, @supabase/supabase-js)
- [ ] Create Supabase client configuration in `/lib/auth/supabase.ts` following existing `/lib/supabase.ts` pattern
- [ ] Configure Next.js middleware for authentication route protection (`middleware.ts`)
- [ ] Implement auth context provider for React state management
- [ ] Create protected route wrapper components for dashboard access

### Task 2: Route Structure Implementation (AC: 2)
- [ ] Restructure `/app` directory using route groups per architecture specs:
  - [ ] Move existing pages to `(marketing)` route group
  - [ ] Create `(auth)` route group for login/register pages
  - [ ] Create `/dashboard` directory for guard management routes
  - [ ] Create route group structure: `(admin)`, `(manager)`, `(guard)` in dashboard
- [ ] Configure layout hierarchies for marketing vs authenticated sections
- [ ] Implement navigation components with role-based visibility

### Task 3: Environment and Deployment Configuration (AC: 3, 4)
- [ ] Update Vercel project configuration for hybrid deployment
- [ ] Configure environment variables for Supabase auth across environments
- [ ] Set up Vercel deployment with authentication middleware support
- [ ] Update next.config.mjs for hybrid static/dynamic route handling
- [ ] Configure build optimization for both static marketing and authenticated routes

### Task 4: Database Schema Foundation (AC: 5)
- [ ] Create Supabase migration files for user roles and permissions
- [ ] Implement RLS policies for role-based data access
- [ ] Create user_roles table with enum constraints (admin, manager, guard, client)
- [ ] Set up audit logging table structure for role changes
- [ ] Create indexes following performance recommendations from architecture docs

### Task 5: Testing Framework Implementation (AC: 6)
- [ ] Install Jest and React Testing Library for component testing
- [ ] Set up Playwright for end-to-end testing
- [ ] Configure test databases for isolated testing
- [ ] Create test utilities for authentication flows
- [ ] Set up CI/CD pipeline with automated testing

## Dev Notes

### Previous Story Insights
No previous story exists - this is the foundation story for the entire Guard Management Platform.

### Data Models
**User Roles & Permissions (RBAC)** [Source: architecture/data-models-and-schema-changes.md#user-roles-permissions-rbac]
- Table: `user_roles` with UUID primary key and B-tree index
- Fields: `user_id` (FK to auth.users), `role` ENUM('admin', 'manager', 'guard', 'client'), `permissions` JSONB
- Relationships: One-to-many with auth.users, one-to-many with guards, shifts, audit logs
- RLS policies required for role-based data access enforcement

### API Specifications
**Authentication Integration** [Source: architecture/tech-stack-alignment.md#new-technology-additions]
- JWT Decode 4.0.0 for custom claims extraction required for RBAC implementation
- Client-side token parsing for role determination
- Integration with existing Supabase client configuration pattern

### Component Specifications
**Route Group Architecture** [Source: architecture/source-tree-integration.md#new-file-organization]
- Use Next.js route groups: `(marketing)`, `(auth)`, dashboard with nested `(admin)`, `(manager)`, `(guard)`
- Component naming: PascalCase.tsx (e.g., GuardProfileForm.tsx)
- Barrel exports in each major directory for clean imports
- Path aliases using @/ prefix consistent with existing pattern

### File Locations
**Enhanced App Router Structure** [Source: architecture/source-tree-integration.md#new-file-organization]
- `/app/(marketing)/` - public marketing pages (move existing pages here)
- `/app/(auth)/` - authentication pages (login, register)
- `/app/dashboard/` - guard management routes with role-based sub-routes
- `/app/api/v1/` - versioned API routes for guard management
- `/lib/auth/` - authentication services and utilities
- `/components/dashboard/` - dashboard-specific components

### Technical Constraints
**Deployment Strategy** [Source: architecture/infrastructure-and-deployment-integration.md#enhancement-deployment-strategy]
- Hybrid Multi-Platform: Continue AWS Amplify for marketing, migrate to Vercel for guard management
- Single Supabase project with expanded schema
- Route-based traffic splitting between platforms
- GitHub Actions for coordinated multi-platform deployment

**Backward Compatibility Requirements** [Source: architecture/data-models-and-schema-changes.md#schema-integration-strategy]
- All existing queries must continue to work unchanged
- Marketing functionality completely isolated from guard management schema
- No breaking changes to current API endpoints or database structure
- Consultation_requests table remains untouched

### Testing Requirements
**Testing Strategy** [Source: architecture/testing-strategy.md#new-testing-requirements]
- Framework: Jest + React Testing Library (Next.js standard)
- Location: `__tests__/` directories co-located with components
- Coverage: 95% for business logic, 85% for UI components
- Database tests: pgTAP with Supabase CLI integration in `supabase/tests/database/`
- E2E tests: Playwright for complete workflows
- CI/CD: GitHub Actions pipeline with automated testing

**Test File Organization** [Source: architecture/testing-strategy.md#integration-with-existing-tests]
- Create `tests/` directory with unit, integration, and database test folders
- Co-locate component tests in `__tests__/` directories
- Target 90%+ coverage for critical workflows

## Testing
### Test Standards [Source: architecture/testing-strategy.md]
- **Unit Tests**: Jest + React Testing Library in `__tests__/` directories
- **Database Tests**: pgTAP framework in `supabase/tests/database/`
- **E2E Tests**: Playwright for complete authentication workflows
- **Coverage Requirements**: 95% business logic, 85% UI components
- **CI/CD Integration**: GitHub Actions pipeline runs full test suite on every PR

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-22 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References  
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*
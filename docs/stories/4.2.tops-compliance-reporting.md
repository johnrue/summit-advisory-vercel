# Story 4.2: TOPS Compliance Reporting

## Status
üìù **Draft** - Ready for review and implementation

## Story
**As a** manager,
**I want** to generate TOPS-compliant reports with all required guard information,
**so that** I can pass regulatory audits and demonstrate full compliance with Texas security industry requirements.

## Acceptance Criteria
1. Create TOPS compliance report generator with all required fields (guard roster, certifications, background checks)
2. Implement automated report generation triggered by date ranges and compliance deadlines
3. Configure sensitive data masking in reports based on user role permissions (SSN visible only to Manager/Admin)
4. Create exportable report formats (PDF, CSV) with official letterhead and compliance attestations
5. Implement report scheduling system with automatic delivery to compliance stakeholders
6. Configure report audit trail tracking who generated reports and when for accountability

## Tasks / Subtasks

### Task 1: TOPS Report Generator (AC: 1, 3)
- [ ] Create ComplianceReportService with TOPS report template
- [ ] Implement guard roster reporting with all required TOPS fields
- [ ] Add certification status and expiry reporting
- [ ] Add background check status reporting
- [ ] Implement role-based data masking (SSN only for Manager/Admin)
- [ ] Test report generation with sample guard data

### Task 2: Report Export Formats (AC: 4)
- [ ] Create PDF report generation with official Summit Advisory letterhead
- [ ] Add CSV export functionality for data analysis
- [ ] Include compliance attestation statements in PDF reports
- [ ] Add report metadata (generation date, generated by, report period)
- [ ] Test both PDF and CSV export formats

### Task 3: Automated Report Generation (AC: 2, 5)
- [ ] Create scheduled report generation system
- [ ] Implement date range and deadline-based triggers
- [ ] Add automatic email delivery to compliance stakeholders
- [ ] Create report scheduling interface for managers
- [ ] Test automated generation and delivery workflows

### Task 4: Report Audit Trail (AC: 6)
- [ ] Integrate report generation with audit logging system
- [ ] Track who generated reports and when
- [ ] Log report parameters (date range, recipients, format)
- [ ] Add report access history tracking
- [ ] Test audit trail integration and logging

## Dev Notes

### TOPS Compliance Requirements
Based on Texas DPS requirements, reports must include:
- Guard roster with license numbers and expiry dates
- Certification status (active/expired/pending renewal)
- Background check completion dates and status
- Employment status and dates
- Training completion records

### Required Dependencies
```json
{
  "@react-pdf/renderer": "^4.0.0",
  "resend": "^4.0.0",
  "@react-email/components": "^0.0.25",
  "@vercel/blob": "^0.23.4"
}
```

### Summit Advisory Branding Standards
- **Company Name**: Summit Advisory
- **License**: TX DPS #C29754001
- **Contact**: (830) 201-0414
- **Service Areas**: Houston, Dallas, Austin, San Antonio
- **Colors**: Primary gold (#43 22% 51%), charcoal black (#0 0% 10%)

### Database Schema Additions
```sql
-- Report tracking and storage table
CREATE TABLE compliance_reports (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  report_type VARCHAR(50) NOT NULL, -- 'tops_compliance'
  generated_by UUID REFERENCES auth.users(id),
  report_period_start DATE NOT NULL,
  report_period_end DATE NOT NULL,
  parameters JSONB, -- report parameters and filters
  blob_url TEXT, -- Vercel Blob storage URL for PDF
  file_size BIGINT, -- file size in bytes
  recipients TEXT[], -- email recipients
  email_status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'sent', 'failed'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_compliance_reports_generated_by ON compliance_reports(generated_by);
CREATE INDEX idx_compliance_reports_created_at ON compliance_reports(created_at DESC);
```

### Key Files to Create/Modify
- `lib/services/compliance-report-service.ts` - Main report generation service
- `components/admin/compliance-reports.tsx` - Report generation interface
- `lib/utils/pdf-generator.ts` - PDF report generation using @react-pdf/renderer
- `lib/utils/email-service.ts` - Email delivery using Resend API
- `app/api/compliance-reports/route.ts` - Report generation and storage API
- `lib/templates/tops-report-template.tsx` - TOPS report PDF template with Summit Advisory branding
- `app/api/compliance-reports/email/route.ts` - Email delivery API endpoint

### Technical Implementation Stack
- **PDF Generation**: @react-pdf/renderer for React-based PDF creation
- **Email Service**: Resend API for reliable email delivery
- **File Storage**: Vercel Blob for PDF storage and public access
- **Branding**: Summit Advisory letterhead with TX DPS #C29754001 license

### Service Pattern
```typescript
// Generate and store TOPS compliance report
const report = await complianceReportService.generateTOPSReport({
  startDate: new Date('2025-01-01'),
  endDate: new Date('2025-01-31'),
  format: 'pdf',
  includeSensitiveData: userRole === 'manager' || userRole === 'admin',
  recipients: ['compliance@summitadvisoryfirm.com']
})

// Report includes:
// - PDF stored in Vercel Blob with public URL
// - Email delivery via Resend API
// - Audit trail integration
// - Role-based data masking
```

### Testing Approach
- Unit tests for report generation, data masking, and PDF creation
- Integration tests with existing guard data and Vercel Blob storage
- Manual testing of PDF generation with @react-pdf/renderer
- Email delivery testing with Resend API
- Role-based data masking validation
- File storage and retrieval testing with Vercel Blob

## Testing
- **Unit Tests**: ComplianceReportService functions, data masking logic
- **Integration Tests**: Report generation with real guard data, audit logging integration
- **Manual Testing**: PDF generation, CSV export, email delivery, scheduling interface

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-28 | 1.0 | Initial story creation | Scrum Master |
| 2025-01-28 | 1.1 | Added technical implementation details from Reference MCP research | Product Owner |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be completed by dev agent*

### Debug Log References
*To be completed by dev agent*

### Completion Notes List
*To be completed by dev agent*

### File List
*To be completed by dev agent*

## QA Results
*This section will be populated by the QA agent after implementation review*
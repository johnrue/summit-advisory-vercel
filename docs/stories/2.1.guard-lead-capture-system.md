# Story 2.1: Guard Lead Capture System

## Status
Draft

## Story
**As a** potential guard,
**I want** to easily express interest in working with Summit Advisory,
**so that** I can begin the application process without friction while enabling the company to track and follow up on my interest.

## Acceptance Criteria
1. Create minimal lead capture form accepting only name and email with source tracking
2. Implement automated email reminder system with configurable cadence (2 days, 7 days)
3. Generate secure application link that prevents unauthorized access and tracks completion status
4. Store lead data with source attribution and timestamp for conversion tracking
5. Create lead management interface for managers to view and manually follow up on leads
6. Implement mobile-optimized lead capture form accessible via QR codes and social media

## Tasks / Subtasks

### Task 0: Foundation Validation (Prerequisites)
- [ ] Verify Epic 1 completion: Authentication infrastructure, RBAC system, role-based dashboards
- [ ] Confirm existing consultation_requests table and service patterns can be extended
- [ ] Validate Supabase email integration and SMTP configuration
- [ ] Ensure existing QR redirect system supports lead capture campaign tracking

### Task 1: Database Schema for Lead Capture (AC: 1, 4)
- [ ] Create guard_leads table with source attribution and timestamp tracking
- [ ] Add lead_source ENUM type (qr_code, website, referral, social_media, other)
- [ ] Implement RLS policies for lead data access (managers and admins only)
- [ ] Add indexes for performance on created_at, lead_source, and status columns
- [ ] Create database migration script following Supabase patterns

### Task 2: Lead Capture Form Component (AC: 1, 6)
- [ ] Create GuardLeadCaptureForm component extending existing form patterns from contact.tsx
- [ ] Implement React Hook Form + Zod validation following consultation form standards
- [ ] Add source tracking field (hidden) to capture campaign attribution
- [ ] Create mobile-responsive design using existing Tailwind patterns
- [ ] Add success state with clear next steps messaging
- [ ] Integrate with existing shadcn/ui components (Card, Button, Input, Form)

### Task 3: Lead Capture Service Layer (AC: 1, 4)
- [ ] Create guard-lead-service.ts following existing consultation-service.ts patterns
- [ ] Implement CRUD operations for lead management with proper error handling
- [ ] Add lead source attribution and timestamp tracking
- [ ] Create service methods for lead status transitions and follow-up tracking
- [ ] Implement data validation and sanitization following existing patterns

### Task 4: API Routes for Lead Capture (AC: 1, 4)
- [ ] Create POST /api/v1/leads/capture route for lead form submission
- [ ] Create GET /api/v1/leads route for manager lead list (with pagination)
- [ ] Create PUT /api/v1/leads/:id/status route for lead status updates
- [ ] Implement proper authentication and role-based access control
- [ ] Add comprehensive error handling and logging following existing API patterns

### Task 5: Lead Management Interface (AC: 5)
- [ ] Create LeadManagementPage for managers in dashboard/(manager)/leads/
- [ ] Implement lead list with filtering by source, date range, and status
- [ ] Add lead detail view with contact information and follow-up history
- [ ] Create manual follow-up action buttons and note-taking interface
- [ ] Integrate with existing dashboard layout and navigation patterns
- [ ] Add lead status indicators and conversion tracking metrics

### Task 6: Secure Application Link Generation (AC: 3)
- [ ] Create secure application link generation service with expiring tokens
- [ ] Implement application link validation and access control
- [ ] Create application status tracking (link generated, clicked, completed)
- [ ] Add link expiry handling with renewal capability
- [ ] Integrate with email reminder system for application completion tracking

### Task 7: Email Reminder System (AC: 2)
- [ ] Create email reminder service using Supabase Edge Functions
- [ ] Implement configurable reminder cadence (2 days, 7 days, custom intervals)
- [ ] Create email templates for different reminder stages
- [ ] Add email delivery tracking and bounce handling
- [ ] Implement unsubscribe functionality and preference management
- [ ] Schedule automated reminder jobs using Supabase cron functions

### Task 8: QR Code Integration (AC: 6)
- [ ] Extend existing QR redirect system to support lead capture campaigns
- [ ] Create QR-specific lead capture landing page with campaign tracking
- [ ] Add lead source attribution for QR code campaigns
- [ ] Test QR code flow from scan to lead capture completion
- [ ] Update existing analytics tracking for lead capture metrics

## Dev Notes

### Previous Story Integration
Building on Epic 1 (Stories 1.1-1.5) completion, this story extends the existing architecture:
- ✅ **Authentication Foundation**: Modern `@supabase/ssr` with JWT role extraction ready for manager access
- ✅ **RBAC Infrastructure**: Role-based access control for manager lead management interface
- ✅ **Dashboard Framework**: Manager dashboard layout ready for lead management pages
- ✅ **Existing Form Patterns**: consultation form (contact.tsx) provides proven form handling patterns
- ✅ **QR System Foundation**: Existing QR redirect system ready for lead capture campaign extension

### Data Models

**Guard Leads Table** [Source: architecture/data-models-and-schema-changes.md#hiring-pipeline-kanban]:
```sql
CREATE TABLE public.guard_leads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  first_name VARCHAR(100) NOT NULL,
  last_name VARCHAR(100) NOT NULL,
  email VARCHAR(255) NOT NULL,
  phone VARCHAR(20),
  lead_source lead_source_enum NOT NULL DEFAULT 'website',
  source_details JSONB, -- Campaign tracking, QR code ID, referral info
  status lead_status_enum NOT NULL DEFAULT 'new',
  notes TEXT,
  assigned_manager_id UUID REFERENCES auth.users(id),
  application_link_token VARCHAR(255) UNIQUE,
  application_link_expires_at TIMESTAMPTZ,
  application_completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE lead_source_enum AS ENUM (
  'website', 'qr_code', 'referral', 'social_media', 'job_board', 'walk_in', 'other'
);

CREATE TYPE lead_status_enum AS ENUM (
  'new', 'contacted', 'application_sent', 'application_received', 'qualified', 'rejected'
);

-- RLS Policies following existing patterns
ALTER TABLE guard_leads ENABLE ROW LEVEL SECURITY;

-- Managers and admins can view/manage all leads
CREATE POLICY "Managers can manage leads" ON guard_leads 
  FOR ALL TO authenticated 
  USING (
    EXISTS (
      SELECT 1 FROM auth.users 
      WHERE auth.users.id = auth.uid() 
      AND auth.users.raw_user_meta_data->>'role' IN ('admin', 'manager')
    )
  );

-- Public can insert new leads (lead capture form)
CREATE POLICY "Public can create leads" ON guard_leads 
  FOR INSERT TO public 
  WITH CHECK (true);
```

### API Specifications

**Lead Capture API** [Source: architecture/api-design-and-integration.md#hiring-pipeline-apis]:
```typescript
// POST /api/v1/leads/capture
interface GuardLeadCaptureRequest {
  first_name: string;
  last_name: string;
  email: string;
  phone?: string;
  lead_source: LeadSource;
  source_details?: Record<string, any>; // Campaign tracking
}

interface GuardLeadCaptureResponse {
  success: boolean;
  data: {
    id: string;
    application_link?: string;
    estimated_contact_time: string;
  };
  error?: string;
}

// GET /api/v1/leads (Manager access)
interface LeadListRequest {
  page?: number;
  limit?: number;
  source_filter?: LeadSource[];
  status_filter?: LeadStatus[];
  date_from?: string;
  date_to?: string;
}

interface LeadListResponse {
  success: boolean;
  data: {
    leads: GuardLead[];
    pagination: {
      total: number;
      page: number;
      pages: number;
    };
  };
}
```

### Component Specifications

**Lead Capture Components** [Source: architecture/component-architecture.md#guard-profile-management]:
```typescript
// Guard lead capture form component
interface GuardLeadCaptureFormProps {
  leadSource?: LeadSource;
  sourceDetails?: Record<string, any>;
  onSuccess?: (leadId: string) => void;
  onError?: (error: string) => void;
  className?: string;
}

// Manager lead management interface
interface LeadManagementBoardProps {
  initialFilters?: LeadFilters;
  onLeadSelect?: (lead: GuardLead) => void;
  showMetrics?: boolean;
  className?: string;
}

// Lead detail viewer component
interface LeadDetailViewerProps {
  leadId: string;
  lead?: GuardLead;
  onStatusChange?: (leadId: string, status: LeadStatus) => void;
  onNotesUpdate?: (leadId: string, notes: string) => void;
  canEdit?: boolean;
  className?: string;
}
```

### File Locations

**Service Layer** [Source: architecture/source-tree-integration.md#enhanced-service-layer]:
- `/lib/services/guard-lead-service.ts` - Lead capture and management logic
- `/lib/services/email-reminder-service.ts` - Automated email reminder system
- `/lib/services/application-link-service.ts` - Secure application link generation
- `/lib/types/guard-leads.ts` - TypeScript interfaces for leads

**API Routes** [Source: architecture/source-tree-integration.md#api-routes]:
- `/app/api/v1/leads/capture/route.ts` - Lead form submission endpoint
- `/app/api/v1/leads/route.ts` - Lead management endpoints (list, update)
- `/app/api/v1/leads/[id]/status/route.ts` - Lead status update endpoint
- `/app/api/v1/leads/[id]/application-link/route.ts` - Application link management

**UI Components** [Source: architecture/source-tree-integration.md#enhanced-component-library]:
- `/components/leads/` - Lead capture and management components
  - `GuardLeadCaptureForm.tsx` - Main lead capture form
  - `LeadManagementBoard.tsx` - Manager lead management interface  
  - `LeadDetailViewer.tsx` - Individual lead detail view
  - `LeadMetrics.tsx` - Lead conversion tracking dashboard
  - `EmailReminderScheduler.tsx` - Email reminder configuration

**Dashboard Pages** [Source: architecture/source-tree-integration.md#dashboard-routes]:
- `/app/dashboard/(manager)/leads/page.tsx` - Lead management page for managers
- `/app/dashboard/(admin)/leads/page.tsx` - Lead analytics and management for admins
- `/app/leads/capture/page.tsx` - Public lead capture page (QR code destination)

**Supabase Edge Functions** [Source: architecture/source-tree-integration.md#supabase-edge-functions]:
- `/supabase/functions/email-reminder-scheduler/index.ts` - Automated email reminder system
- `/supabase/functions/lead-notification-handler/index.ts` - Real-time lead notifications

### Integration with Existing Systems

**QR Code System Extension** [Source: existing CLAUDE.md QR system]:
- Extend existing `/app/qr/page.tsx` to support lead capture campaigns
- Add lead_source attribution for QR code campaigns with campaign tracking
- Integrate with existing Google Analytics event tracking for lead capture metrics

**Consultation Service Patterns** [Source: existing lib/consultation-service.ts]:
- Follow existing error handling patterns with ServiceResult<T> types
- Use existing Supabase client configuration and connection patterns
- Implement consistent logging and audit trail following consultation request patterns

**Authentication Integration** [Source: Epic 1 completion]:
- Use existing JWT role validation for manager lead management access
- Integrate with existing RBAC system for permission-based UI controls
- Follow existing dashboard layout patterns for manager lead management interface

### Security Considerations

**Data Protection** [Source: architecture/security-integration.md]:
- Lead capture form publicly accessible (no authentication required)
- Lead management interface restricted to authenticated managers and admins
- Application link tokens expire after configurable period (default 7 days)
- Email addresses validated and sanitized before storage
- PII handling follows existing consultation request security patterns

**Access Control** [Source: architecture/data-models-and-schema-changes.md#schema-integration-strategy]:
- RLS policies ensure only managers/admins can view lead data
- Application links use secure tokens to prevent unauthorized access
- Lead source attribution protects campaign effectiveness data

### Technical Constraints

**Performance Requirements**:
- Lead capture form submission <500ms response time
- Lead management page loads <1s with 100+ leads
- Email reminder processing handles 1000+ leads efficiently
- Database queries optimized with appropriate indexes

**Integration Constraints** [Source: architecture/coding-standards-and-conventions.md#critical-integration-rules]:
- Must maintain existing consultation_requests table functionality
- Follow existing API response format patterns (ServiceResult<T>)
- Use existing Supabase client configuration for consistency
- Preserve existing marketing site performance and functionality

## Testing

### Test Standards [Source: architecture/testing-strategy.md]
- **Unit Tests**: Jest + React Testing Library in `__tests__/` directories
- **Database Tests**: pgTAP framework in `supabase/tests/database/`
- **E2E Tests**: Playwright for complete lead capture workflow
- **Coverage Requirements**: 95% business logic, 85% UI components

**Lead Capture Test Cases**:
- Lead form submission with all field combinations and validation
- QR code campaign attribution and source tracking
- Manager lead management interface access and filtering
- Email reminder system scheduling and delivery
- Application link generation, validation, and expiry
- Database RLS policies for lead data access control
- API endpoint authentication and error handling
- Mobile responsive form behavior across devices

**Database Test Cases**:
```sql
-- supabase/tests/database/guard_leads_rls.test.sql
-- Test lead capture RLS policies
-- Test manager access to lead data
-- Test application link token security
-- Test lead source attribution integrity
```

**Integration Test Cases**:
```typescript
// __tests__/leads/lead-capture-flow.test.ts  
// End-to-end lead capture from QR code to manager interface
// Email reminder scheduling and delivery
// Application link generation and validation workflow
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-26 | 1.0 | Initial story creation for Epic 2 Guard Hiring Pipeline | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*  

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*This section will be populated by the QA agent during review*